<!--Start Breadcrumb-->
<div class="row">
	<div id="breadcrumb" class="col-xs-12">
		<ol class="breadcrumb">
			<li><a href="../index.html">Repository</a></li>
		</ol>
	</div>
</div>
<!--End Breadcrumb-->
<!--Start Dashboard-->
<div class="row-fluid">
	<div id="dashboard_tabs" class="col-xs-12 col-sm-10 col-md-12"></div>
	<div class="clearfix"></div>
</div>
<!--End Dashboard-->
<div style="height: 40px;"></div>

<script type="text/javascript">
    //IP del Navi i del repository
    var naviIP = "localhost:8080";
    var repIP = "37.187.9.5:7777";
    var databaseIP = "37.187.9.5:13370";
    var naviID = "1";

    $(document).ready(function() {
        var appsRep = [];
        var appContainer;
        $(".preloader").show();
        $.ajax({
            url: "http://" + databaseIP + "/app",
            async: false,
            dataType: "json",
            success: function (apps_data) {
                // Generar HTML per a totes les apps disponibles a la DB
                $.each (apps_data, function (key, app) {
                    appContainer = '<div class="col-xs-12 col-sm-6 col-md-4 ow-server">' +
                                        '<h4 class="page-header text-right"><i class="fa fa-linux"></i>' + app.name + '</h4>' +
                                        '<div class="row ow-server-bottom">' +
                                            '<div class="col-sm-4 text-center">' +
                                                '<img src="http://' + repIP + '/repository/' + app.dir + '/' + app.icon + '" class="img-rounded app">' +
                                            '</div>' +
                                            '<div class="col-sm-8">' +
                                                '<div class="row"><i class="fa fa-lock"></i> ' + app.cat + '</div>' +
                                                '<div class="row"><i class="fa fa-clock-o"></i> Uptime - 10 days</div>' +
                                                '<div class="row">' +
                                                    '<div class="col-md-6">' +
                                                        '<div class="toggle-switch toggle-switch-primary">' +
                                                            '<label>' +
                                                                '<input type="checkbox" id="install" value="' + app.id + '"></input>' +
                                                                '<div class="toggle-switch-inner" id="install"></div>' +
                                                                '<div class="toggle-switch-switch">' +
                                                                    '<i class="fa fa-check"></i>' +
                                                                '</div>' +
                                                            '</label>' +
                                                        '</div>' +
                                                    '</div>' +
                                                    '<div class="col-md-6">' +
                                                        '<div class="toggle-switch toggle-switch-primary">' +
                                                            '<label>' +
                                                                '<input type="checkbox" id="enable" value="' + app.id + '" disabled = "true"></input>' +
                                                                '<div class="toggle-switch-inner" id="enable"></div>' +
                                                                '<div class="toggle-switch-switch">' +
                                                                    '<i class="fa fa-check"></i>' +
                                                                '</div>' +
                                                            '</label>' +
                                                        '</div>' +
                                                    '</div>' +
                                                '</div>' +
                                            '</div>' +
                                        '</div>' +
                                    '</div>';
                    appsRep.push(appContainer);
                });

                //Afegir tot el HTML de les apps disponibles i ocultar
                $("<div>", {
                    "id": "dashboard-servers",
                    "class": "row",
                    "style": "visibility: visible; position: relative;",
                    html: appsRep.join("")
                }).appendTo("#dashboard_tabs").hide();

                //Settejar lestat corresponen a cada app del Navi
                $.ajax({
                    url: "http://" + databaseIP + "/navi/" + naviID,
                    async: false,
                    dataType: "json",
                    success: function (state_data) {
                        //Aplicar lestat de les app installed
                        $.each (state_data['installed'], function (key, app) {
                            $("#install[value='" + app.id + "']").prop('checked', true);
                            $("#enable[value='" + app.id + "']").prop('disabled', false);
                        });
                        //Aplicar lestat de les app enabled
                        $.each (state_data['enabled'], function (key, app) {
                            $("#enable[value='" + app.id + "']").prop('disabled', false);
                            $("#enable[value='" + app.id + "']").prop('checked', true);
                        });
                    },
                    error: function (e) {
                        alert('Database Connection State Error: ' + e);
                    }
                });
                $("#dashboard-servers").show();
                $(".preloader").hide();
            },
            error: function (e) {
                alert('Database Connection Apps Error: ' + e);
            }
        });



        $(document).off('click', 'input[type=checkbox]').on('click', 'input[type=checkbox]', function(){
            if(this.id == "enable") {
                if($(this).is(':checked')){
                    appOperation("start", $(this).val());
                    console.log((this.id) + " " + $(this).val() + " checked");
                }
                else {
                    appOperation("stop", $(this).val());
                    console.log((this.id) + " " + $(this).val() + " unchecked");
                }
            }
            else if(this.id == "install") {
                if($(this).is(':checked')){
                    appOperation("install", $(this).val());
                    $("#enable[value='" + $(this).val() + "']").prop('disabled', false);
                }
                else {
                    appOperation("remove", $(this).val());
                    $("#enable[value='" + $(this).val() + "']").prop('checked', false);
                    $("#enable[value='" + $(this).val() + "']").prop('disabled', true);
                }
            }
        });



        function appOperation(primitive, appID) {
            $.ajax({
                url: "http://" + naviIP + "/" + primitive + "/" + appID,
                dataType: "json",
                success: function (json_data) {
                    var resp = jQuery.parseJSON(json_data);
                    console.log("Success: " + resp.success);
                },
                error: function (e) {
                    alert('Error Operation App: ' + e);
                }
            });
        }

    });

</script>
