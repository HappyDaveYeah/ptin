<!--Start Breadcrumb-->
<div class="row">
	<div id="breadcrumb" class="col-xs-12">
		<ol class="breadcrumb">
			<li><a href="../index.html">Repository</a></li>
		</ol>
	</div>
</div>
<!--End Breadcrumb-->
<!--Start Dashboard 2-->
<div class="row-fluid">
	<div id="dashboard_tabs" class="col-xs-12 col-sm-10 col-md-12">
		<!--Start Dashboard Tab 4-->

		<!--End Dashboard Tab 4-->
	</div>
	<div class="clearfix"></div>
</div>
<!--End Dashboard 2 -->
<div style="height: 40px;"></div>

<script type="text/javascript">
    //IP del Navi i del repository
    var naviIP = "localhost:8080";
    var databaseIP = "37.187.9.5:13370";
    var repIP = "37.187.9.5:7777";

    $(document).ready(function() {
        var appsNavi;
        var appsRep = [];
        var appContainer;

        $.ajax({
            url: "http://" + databaseIP + "/app",
            async: false,
            dataType: "json",
            success: function (apps_data) {
                $.ajax({
                    url: "http://" + naviIP + "/getApps",
                    async: false,
                    dataType: "json",
                    success: function (json_data) {
                        appsNavi = jQuery.parseJSON(json_data);
                    },
                    error: function (e) {
                        alert('Navi Connection Error: ' + e);
                    }
                });

                console.log(appsNavi);
                console.log(appsNavi[0].id);

                $.each (apps_data, function (key, val) {
                    var installed = '';
                    var enabled = '';
                    var disabled = '';
                    var appFound = $.grep(appsNavi, function(app){ return app.id == val.id; });
                    if(appFound.length == 1 ){
                        installed = 'checked=""';
                        if(appFound[0].enabled == 1){
                            enabled = 'checked=""';
                        }
                    }
                    else {
                        disabled = 'disabled = "true"'
                    }

                    appContainer = '<div class="col-xs-12 col-sm-6 col-md-4 ow-server">' +
                                        '<h4 class="page-header text-right"><i class="fa fa-linux"></i>' + val.name + '</h4>' +
                                        '<div class="row ow-server-bottom">' +
                                            '<div class="col-sm-4 text-center">' +
                                                '<img src="http://' + repIP + '/repository/' + val.dir + '/' + val.icon + '" class="img-rounded app">' +
                                            '</div>' +
                                            '<div class="col-sm-8">' +
                                                '<div class="row"><i class="fa fa-lock"></i> ' + val.cat + '</div>' +
                                                '<div class="row"><i class="fa fa-clock-o"></i> Uptime - 10 days</div>' +
                                                '<div class="row">' +
                                                    '<div class="col-md-6">' +
                                                        '<div class="toggle-switch toggle-switch-primary">' +
                                                            '<label>' +
                                                                '<input type="checkbox" ' + installed + '" id="install" value="' + val.id + '"></input>' +
                                                                '<div class="toggle-switch-inner" id="install"></div>' +
                                                                '<div class="toggle-switch-switch">' +
                                                                    '<i class="fa fa-check"></i>' +
                                                                '</div>' +
                                                            '</label>' +
                                                        '</div>' +
                                                    '</div>' +
                                                    '<div class="col-md-6">' +
                                                        '<div class="toggle-switch toggle-switch-primary">' +
                                                            '<label>' +
                                                                '<input type="checkbox" ' + enabled + '" id="enable" value="' + val.id + '" ' + disabled + '></input>' +
                                                                '<div class="toggle-switch-inner" id="enable"></div>' +
                                                                '<div class="toggle-switch-switch">' +
                                                                    '<i class="fa fa-check"></i>' +
                                                                '</div>' +
                                                            '</label>' +
                                                        '</div>' +
                                                    '</div>' +
                                                '</div>' +
                                            '</div>' +
                                        '</div>' +
                                    '</div>';
                    appsRep.push(appContainer);
                });

                $("<div>", {
                    "id": "dashboard-servers",
                    "class": "row",
                    "style": "visibility: visible; position: relative;",
                    html: appsRep.join("")
                }).appendTo("#dashboard_tabs");
            },
            error: function (e) {
                alert('Database Connection Error: ' + e);
            }
        });



        $(document).off('click', 'input[type=checkbox]').on('click', 'input[type=checkbox]', function(){
            if(this.id == "enable") {
                if($(this).is(':checked')){
                    appOperation("START", $(this).val());
                    console.log((this.id) + " " + $(this).val() + " checked");
                }
                else {
                    appOperation("STOP", $(this).val());
                    console.log((this.id) + " " + $(this).val() + " unchecked");
                }
            }
            else if(this.id == "install") {
                if($(this).is(':checked')){
                    appOperation("ADD", $(this).val());
                    $("#enable[value='" + $(this).val() + "']").prop('disabled', false);
                }
                else {
                    appOperation("DEL", $(this).val());
                    $("#enable[value='" + $(this).val() + "']").prop('checked', false);
                    $("#enable[value='" + $(this).val() + "']").prop('disabled', true);
                }
            }
        });



        function appOperation(primitive, appID) {
            $.ajax({
                url: "http://" + naviIP + "/" + primitive + "/" + appID,
                dataType: "json",
                success: function (json_data) {
                    var resp = jQuery.parseJSON(json_data);
                    console.log("Success: " + resp.success);
                },
                error: function (e) {
                    alert('Error Operation App: ' + e);
                }
            });
        }

    });

</script>
